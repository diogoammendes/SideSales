{% extends "base.html" %}
{% block title %}Dashboard · SideSales{% endblock %}
{% block content %}
<section class="dashboard-hero">
    <div class="hero-copy">
        <span class="eyebrow">Panorama geral</span>
        <h2>Status financeiro do portefólio</h2>
        <p class="muted">Resultados atuais baseados em vendas realizadas e visão futura com rascunhos.</p>
        <a href="{% url 'operations:purchase_create' %}" class="btn primary">Nova compra</a>
    </div>
    <div class="hero-grid">
        <article class="metric-card">
            <span class="label">Investimento total</span>
            <span class="value">{{ totals.invested|default:0|floatformat:2 }} €</span>
        </article>
        <article class="metric-card">
            <span class="label">Receita realizada</span>
            <span class="value">{{ totals.revenue|default:0|floatformat:2 }} €</span>
        </article>
        <article class="metric-card">
            <span class="label">Resultado atual</span>
            <span class="value {% if totals.profit < 0 %}text-danger{% else %}text-success{% endif %}">{{ totals.profit|default:0|floatformat:2 }} €</span>
        </article>
        <article class="metric-card highlight">
            <span class="label">Resultado potencial</span>
            <span class="value">{{ projections.profit|default:0|floatformat:2 }} €</span>
            <small class="muted">Inclui receita projetada de {{ projections.revenue|default:0|floatformat:2 }} €</small>
        </article>
    </div>
</section>

<section class="pipeline">
    <article class="pipeline-card">
        <div class="pipeline-header">
            <div>
                <p class="eyebrow">Pipeline de vendas</p>
                <h3>Realizado vs rascunho</h3>
            </div>
        </div>
        <div class="pipeline-progress">
            <div class="progress-fill" style="--progress: {{ sales_summary.realized.share|default_if_none:0|floatformat:0 }}%;"></div>
        </div>
        <div class="pipeline-columns">
            <div class="pipeline-col">
                <span class="label">Vendas realizadas</span>
                <strong>{{ sales_summary.realized.value|default:0|floatformat:2 }} €</strong>
                <p class="muted">{{ sales_summary.realized.count }} vendas · {{ sales_summary.realized.profit|default:0|floatformat:2 }} € lucro · {{ sales_summary.realized.share|default:0|floatformat:0 }}% do total</p>
            </div>
            <div class="pipeline-divider"></div>
            <div class="pipeline-col">
                <span class="label">Rascunhos</span>
                <strong>{{ sales_summary.draft.value|default:0|floatformat:2 }} €</strong>
                <p class="muted">{{ sales_summary.draft.count }} vendas · {{ sales_summary.draft.profit|default:0|floatformat:2 }} € lucro potencial · {{ sales_summary.draft.share|default:0|floatformat:0 }}% do total</p>
            </div>
        </div>
    </article>
</section>

<section class="panel-grid">
    <article class="panel panel-card">
        <header class="panel-header">
            <div>
                <h3>Compras Recentes</h3>
                <p class="muted">Custos x receitas consolidadas</p>
            </div>
        </header>
        <div class="table-wrapper">
        <table class="table">
        <thead>
            <tr>
                <th>Compra</th>
                <th>Investimento</th>
                <th>Receita</th>
                <th>Resultado</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            {% for purchase in purchases %}
                <tr>
                    <td data-label="Compra">
                        <strong>{{ purchase.title }}</strong><br>
                        <small class="muted">{{ purchase.purchased_on }}</small>
                    </td>
                    <td data-label="Investimento">{{ purchase.total_cost|floatformat:2 }} €</td>
                    <td data-label="Receita">{{ purchase.total_revenue|floatformat:2 }} €</td>
                    <td data-label="Resultado" class="{% if purchase.total_profit < 0 %}text-danger{% else %}text-success{% endif %}">{{ purchase.total_profit|floatformat:2 }} €</td>
                    <td data-label="Ações"><a href="{% url 'operations:purchase_detail' purchase.pk %}">ver</a></td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="5" class="muted">Sem compras registadas.</td>
                </tr>
            {% endfor %}
        </tbody>
        </table>
        </div>
    </article>

    <article class="panel panel-card">
        <header class="panel-header">
            <div>
                <h3>Ledger por utilizador</h3>
                <p class="muted">Investimentos registados vs pagamentos recebidos (EUR)</p>
            </div>
        </header>
        <div class="table-wrapper">
        <table class="table">
        <thead>
            <tr>
                <th>Utilizador</th>
                <th>Investido</th>
                <th>Recebido</th>
                <th>Saldo</th>
            </tr>
        </thead>
        <tbody>
            {% for entry in ledger %}
                <tr>
                    <td data-label="Utilizador">
                        <strong>{{ entry.user.get_full_name|default:entry.user.username }}</strong>
                        <small class="muted">{{ entry.user.display_role }}</small>
                    </td>
                    <td data-label="Investido">{{ entry.invested|floatformat:2 }} €</td>
                    <td data-label="Recebido">
                        {{ entry.received_actual|floatformat:2 }} €
                        {% if entry.received_attributed and entry.received_attributed != entry.received_actual %}
                            <small class="muted" title="Receita proporcional pela quota investida">(quota {{ entry.received_attributed|floatformat:2 }} €)</small>
                        {% endif %}
                    </td>
                    <td data-label="Saldo" class="{% if entry.real_balance < 0 %}text-danger{% else %}text-success{% endif %}">{{ entry.real_balance|floatformat:2 }} €</td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="4" class="muted">Sem movimentos por utilizador.</td>
                </tr>
            {% endfor %}
        </tbody>
        </table>
        </div>
    </article>
</section>
{% endblock %}
