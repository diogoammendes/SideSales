{% extends "base.html" %}
{% block title %}Dashboard · SideSales{% endblock %}
{% block content %}
<section class="cards">
    <article class="card">
        <span class="muted">Investimento Total</span>
        <h2>{{ totals.invested|default:0|floatformat:2 }} €</h2>
    </article>
    <article class="card">
        <span class="muted">Receita Total</span>
        <h2>{{ totals.revenue|default:0|floatformat:2 }} €</h2>
    </article>
    <article class="card">
        <span class="muted">Resultado</span>
        <h2 class="{% if totals.profit < 0 %}text-danger{% else %}text-success{% endif %}">{{ totals.profit|default:0|floatformat:2 }} €</h2>
    </article>
</section>

<section class="cards">
    <article class="card">
        <span class="muted">Vendas Realizadas</span>
        <h2>{{ sales_summary.realized.value|default:0|floatformat:2 }} €</h2>
        <p class="muted">{{ sales_summary.realized.count }} vendas · lucro {{ sales_summary.realized.profit|default:0|floatformat:2 }} €</p>
    </article>
    <article class="card">
        <span class="muted">Rascunhos em Pipeline</span>
        <h2>{{ sales_summary.draft.value|default:0|floatformat:2 }} €</h2>
        <p class="muted">{{ sales_summary.draft.count }} vendas · lucro potencial {{ sales_summary.draft.profit|default:0|floatformat:2 }} €</p>
    </article>
</section>

<section class="panel">
    <header class="panel-header">
        <div>
            <h3>Compras Recentes</h3>
            <p class="muted">Custos x receitas consolidadas</p>
        </div>
        <a href="{% url 'operations:purchase_create' %}" class="btn primary">Nova compra</a>
    </header>
    <div class="table-wrapper">
    <table class="table">
        <thead>
            <tr>
                <th>Compra</th>
                <th>Investimento</th>
                <th>Receita</th>
                <th>Resultado</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            {% for purchase in purchases %}
                <tr>
                    <td data-label="Compra">
                        <strong>{{ purchase.title }}</strong><br>
                        <small class="muted">{{ purchase.purchased_on }}</small>
                    </td>
                    <td data-label="Investimento">{{ purchase.total_cost|floatformat:2 }} €</td>
                    <td data-label="Receita">{{ purchase.total_revenue|floatformat:2 }} €</td>
                    <td data-label="Resultado" class="{% if purchase.total_profit < 0 %}text-danger{% else %}text-success{% endif %}">{{ purchase.total_profit|floatformat:2 }} €</td>
                    <td data-label="Ações"><a href="{% url 'operations:purchase_detail' purchase.pk %}">ver</a></td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="5" class="muted">Sem compras registadas.</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
    </div>
</section>

<section class="panel">
    <header class="panel-header">
        <div>
            <h3>Ledger por utilizador</h3>
            <p class="muted">Investimentos registados vs pagamentos recebidos (em EUR)</p>
        </div>
    </header>
    <div class="table-wrapper">
    <table class="table">
        <thead>
            <tr>
                <th>Utilizador</th>
                <th>Investido</th>
                <th>Recebido</th>
                <th>Saldo</th>
            </tr>
        </thead>
        <tbody>
            {% for entry in ledger %}
                <tr>
                    <td data-label="Utilizador">
                        <strong>{{ entry.user.get_full_name|default:entry.user.username }}</strong>
                        <small class="muted">{{ entry.user.display_role }}</small>
                    </td>
                    <td data-label="Investido">{{ entry.invested|floatformat:2 }} €</td>
                    <td data-label="Recebido">
                        {{ entry.received_actual|floatformat:2 }} €
                        {% if entry.received_attributed and entry.received_attributed != entry.received_actual %}
                            <small class="muted" title="Receita proporcional pela quota investida">(quota {{ entry.received_attributed|floatformat:2 }} €)</small>
                        {% endif %}
                    </td>
                    <td data-label="Saldo" class="{% if entry.real_balance < 0 %}text-danger{% else %}text-success{% endif %}">{{ entry.real_balance|floatformat:2 }} €</td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="4" class="muted">Sem movimentos por utilizador.</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
    </div>
</section>
{% endblock %}
