{% extends "base.html" %}
{% block title %}Compra · SideSales{% endblock %}
{% block content %}
<section class="panel">
    <header class="panel-header">
        <div>
            <h2>{{ purchase.title }}</h2>
            <p class="muted">{{ purchase.description|default:'Sem descrição' }}</p>
        </div>
        <div class="line-actions">
            <a href="{% url 'operations:purchase_update' purchase.pk %}" class="btn secondary">Editar</a>
            <a href="{% url 'operations:sale_create' %}?purchase={{ purchase.pk }}" class="btn primary">Nova venda</a>
            {% if user.is_superuser or user.role == 'ADMIN' or user.role == 'MANAGER' %}
                <form method="post" action="{% url 'operations:purchase_delete' purchase.pk %}" class="inline-delete" onsubmit="return confirm('Esta ação é irreversível. Apagar compra?');">
                    {% csrf_token %}
                    <button type="submit" class="btn ghost danger">Apagar compra</button>
                </form>
            {% endif %}
        </div>
    </header>
    <div class="cards">
        <article class="card">
            <span class="muted">Valor total ({{ purchase.total_currency|default:'EUR' }})</span>
            <h3>
                {% if purchase.total_amount_original %}
                    {{ purchase.total_amount_original|floatformat:2 }} {{ purchase.total_currency|default:'EUR' }}
                {% else %}
                    -
                {% endif %}
            </h3>
            <small class="muted">{{ purchase.total_amount_eur|default:0|floatformat:2 }} €</small>
        </article>
        <article class="card">
            <span class="muted">Sinal recebido</span>
            <h3>
                {% if purchase.signal_amount_original %}
                    {{ purchase.signal_amount_original|floatformat:2 }} {{ purchase.signal_currency|default:'EUR' }}
                {% else %}
                    -
                {% endif %}
            </h3>
            <small class="muted">{{ purchase.signal_amount_eur|default:0|floatformat:2 }} €</small>
        </article>
        <article class="card">
            <span class="muted">Quantidade</span>
            <h3>{{ purchase.quantity|floatformat:2 }}</h3>
            <small class="muted">Custo unitário {{ purchase.unit_cost|floatformat:2 }} €</small>
        </article>
        <article class="card">
            <span class="muted">Investimento base</span>
            <h3>{{ purchase.total_base|floatformat:2 }} €</h3>
        </article>
        <article class="card">
            <span class="muted">Custos adicionais</span>
            <h3>{{ purchase.total_additional_costs|floatformat:2 }} €</h3>
        </article>
        <article class="card">
            <span class="muted">Receita</span>
            <h3>{{ purchase.total_revenue|floatformat:2 }} €</h3>
        </article>
        <article class="card">
            <span class="muted">Resultado</span>
            <h3 class="{% if purchase.total_profit < 0 %}text-danger{% else %}text-success{% endif %}">{{ purchase.total_profit|floatformat:2 }} €</h3>
        </article>
    </div>
</section>

<section class="panel">
    <header class="panel-header">
        <div>
            <h3>Participações</h3>
            <p class="muted">Regista quem financiou esta compra.</p>
        </div>
    </header>
    {% if user.is_superuser or user.role == 'ADMIN' or user.role == 'MANAGER' %}
        <div class="entry-form">
            <form method="post" action="{% url 'operations:purchase_contribution_create' purchase.pk %}">
                {% csrf_token %}
                {{ contribution_form.non_field_errors }}
                <div class="form-grid compact">
                    {% for field in contribution_form %}
                        <div class="form-control compact">
                            <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                            {{ field }}
                            {% for error in field.errors %}
                                <small class="error-text">{{ error }}</small>
                            {% endfor %}
                        </div>
                    {% endfor %}
                </div>
                <div class="entry-actions">
                    <button type="submit" class="btn primary">Adicionar participação</button>
                </div>
            </form>
        </div>
    {% endif %}
    {% if purchase.contributions.exists %}
        <div class="line-table">
            {% for contrib in purchase.contributions.all %}
                <div class="line-row">
                    <div class="line-col">
                        <strong>{{ contrib.payer }}</strong>
                        <span class="badge">{{ contrib.get_contribution_type_display }}</span>
                        {% if contrib.notes %}
                            <p class="muted">{{ contrib.notes }}</p>
                        {% endif %}
                    </div>
                    <div class="line-col">
                        <span class="muted">Valor</span>
                        <p>
                            {{ contrib.value|floatformat:2 }}
                            {% if contrib.contribution_type == contrib.ContributionType.PERCENTAGE %}%{% else %} €{% endif %}
                        </p>
                    </div>
                    <div class="line-col">
                        <span class="muted">Valor resolvido (EUR)</span>
                        <p>{{ contrib.resolved_amount|floatformat:2 }} €</p>
                    </div>
                    <div class="line-col">
                        <span class="muted">Pago em</span>
                        <p>{{ contrib.paid_on|date:"d/m/Y" }}</p>
                    </div>
                    {% if user.is_superuser or user.role == 'ADMIN' or user.role == 'MANAGER' %}
                        <div class="line-actions">
                            <form method="post" action="{% url 'operations:purchase_contribution_delete' purchase.pk contrib.pk %}" class="inline-delete" onsubmit="return confirm('Remover esta participação?');">
                                {% csrf_token %}
                                <button type="submit" class="btn ghost danger">Eliminar</button>
                            </form>
                        </div>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    {% else %}
        <p class="muted">Sem participações registadas.</p>
    {% endif %}
</section>

<section class="panel">
    <header class="panel-header">
        <div>
            <h3>Custos adicionais</h3>
            <p class="muted">Lança despesas extra associadas à compra.</p>
        </div>
    </header>
    {% if user.is_superuser or user.role == 'ADMIN' or user.role == 'MANAGER' %}
        <div class="entry-form">
            <form method="post" action="{% url 'operations:additional_cost_create' purchase.pk %}">
                {% csrf_token %}
                {{ cost_form.non_field_errors }}
                <div class="form-grid compact">
                    {% for field in cost_form %}
                        <div class="form-control compact">
                            <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                            {{ field }}
                            {% for error in field.errors %}
                                <small class="error-text">{{ error }}</small>
                            {% endfor %}
                        </div>
                    {% endfor %}
                </div>
                <div class="entry-actions">
                    <button type="submit" class="btn primary">Adicionar custo</button>
                </div>
            </form>
        </div>
    {% endif %}
    {% if purchase.additional_costs.exists %}
        <div class="line-table">
            {% for cost in purchase.additional_costs.all %}
                <div class="line-row">
                    <div class="line-col">
                        <strong>{{ cost.label }}</strong>
                        {% if cost.paid_by %}
                            <span class="badge">Pago por {{ cost.paid_by }}</span>
                        {% endif %}
                    </div>
                    <div class="line-col">
                        <span class="muted">Valor</span>
                        <p>{{ cost.amount|floatformat:2 }} €</p>
                    </div>
                    <div class="line-col">
                        <span class="muted">Incurrido em</span>
                        <p>{{ cost.incurred_on|date:"d/m/Y" }}</p>
                    </div>
                    {% if user.is_superuser or user.role == 'ADMIN' or user.role == 'MANAGER' %}
                        <div class="line-actions">
                            <form method="post" action="{% url 'operations:additional_cost_delete' purchase.pk cost.pk %}" class="inline-delete" onsubmit="return confirm('Remover este custo?');">
                                {% csrf_token %}
                                <button type="submit" class="btn ghost danger">Eliminar</button>
                            </form>
                        </div>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    {% else %}
        <p class="muted">Sem custos adicionais.</p>
    {% endif %}
</section>

<section class="panel">
    <h3>Vendas associadas</h3>
    <div class="table-wrapper">
        <table class="table">
            <thead>
                <tr>
                    <th>Comprador</th>
                    <th>Quantidade</th>
                    <th>Preço unitário</th>
                    <th>Total</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for sale in purchase.sales.all %}
                    <tr>
                        <td data-label="Comprador">{{ sale.buyer_name }}</td>
                        <td data-label="Quantidade">{{ sale.quantity }}</td>
                        <td data-label="Preço unitário">{{ sale.unit_price }}</td>
                        <td data-label="Total">{{ sale.total_price|floatformat:2 }}</td>
                        <td data-label="Status">{{ sale.get_status_display }}</td>
                    </tr>
                    {% if sale.payments.all %}
                        <tr>
                            <td colspan="5">
                                <strong>Pagamentos:</strong>
                                <ul>
                                    {% for payment in sale.payments.all %}
                                        <li>{{ payment.paid_on|date:"d/m/Y" }} · {{ payment.amount|floatformat:2 }} € · {{ payment.get_method_display }} · Recebido por {{ payment.receiver }}</li>
                                    {% endfor %}
                                </ul>
                            </td>
                        </tr>
                    {% endif %}
                {% empty %}
                    <tr><td colspan="5" class="muted">Sem vendas registadas.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</section>
{% endblock %}
